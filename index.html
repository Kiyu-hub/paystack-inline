<script>
  function getQueryParam(key) {
    const url = new URL(window.location.href);
    return url.searchParams.get(key);
  }

  function payNow() {
    const email = getQueryParam("email");
    const amount = parseInt(getQueryParam("amount")); // Already multiplied by 100
    const name = getQueryParam("name");
    const reference = getQueryParam("reference"); // <- This will be orderRefId from FlutterFlow

    // Check that all values are available
    if (!email || !amount || !name || !reference) {
      alert("Missing payment details. Please try again.");
      return;
    }

    const handler = PaystackPop.setup({
      key: 'pk_test_377d9052e929868450af2ed6dfd2bd2e7805010e',
      email: email,
      amount: amount,
      currency: 'GHS',
      ref: reference,
      metadata: {
        custom_fields: [
          {
            display_name: "Customer Name",
            variable_name: "customer_name",
            value: name
          }
        ]
      },
      callback: function(response) {
        console.log("âœ… Payment complete. Reference:", response.reference);
        // Firestore check will handle the next steps
      },
      onClose: function() {
        alert("Payment was cancelled.");
      }
    });

    handler.openIframe();
  }
</script>
